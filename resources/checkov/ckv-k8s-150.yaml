---
category: Security
checkTool: checkov
checkType: Kubernetes
compliance:
  - CIS
description: |-
    Kubernetes is an open source platform for orchestrating containers. A container is a technology that lets you bundle and isolate applications with their entire runtime environment so that it’s easy to move the contained application between stages (development, production, etc.) and environments (on-premise, public cloud, private cloud, hybrid cloud, or multicloud) while retaining full functionality.

    kubelet is the primary "node agent" that runs on each node in a Kubernetes cluster. The kubelet works in terms of a PodSpec. A PodSpec is a YAML or JSON object that describes a pod. The kubelet takes a set of PodSpecs that are provided through various mechanisms (primarily through the apiserver) and ensures that the containers described in those PodSpecs are running and healthy.

    Kubelet has the option to automatically rotate the server certificates required for the encrypted communication with other Kubernetes components. It is recommended to keep this option enabled.
extra:
  entity: containers
  type: resource
guidelines: |-
    #### Description
    Kubernetes is an open source platform for orchestrating containers. A container is a technology that lets you bundle and isolate applications with their entire runtime environment so that it’s easy to move the contained application between stages (development, production, etc.) and environments (on-premise, public cloud, private cloud, hybrid cloud, or multicloud) while retaining full functionality.

    kubelet is the primary "node agent" that runs on each node in a Kubernetes cluster. The kubelet works in terms of a PodSpec. A PodSpec is a YAML or JSON object that describes a pod. The kubelet takes a set of PodSpecs that are provided through various mechanisms (primarily through the apiserver) and ensures that the containers described in those PodSpecs are running and healthy.

    Kubelet has the option to automatically rotate the server certificates required for the encrypted communication with other Kubernetes components. It is recommended to keep this option enabled.

    #### Rationale
    RotateKubeletServerCertificate causes the kubelet to both request a serving certificate after bootstrapping its client credentials and rotate the certificate as its existing credentials expire. This automated periodic rotation ensures that the there are no downtimes due to expired certificates and thus addressing availability in the CIA security triad.

    **Note:** This recommendation only applies if you let kubelets get their certificates from the API server. In case your kubelet certificates come from an outside authority/tool (e.g. Vault) then you need to take care of rotation yourself.

    #### Audit
    Ignore this check if s`erverTLSBootstrap` is true in the kubelet config file or if the `--rotate-server-certificates` parameter is set on kubelet Run the following command on each node:
    ```
     ps -ef | grep kubelet
    ```
    Verify that `RotateKubeletServerCertificate` argument exists and is set to `true`.

    #### Remediation
    Edit the kubelet service file `/etc/systemd/system/kubelet.service.d/10-kubeadm.conf` on each worker node and set the below parameter in `KUBELET_CERTIFICATE_ARGS` variable.
    ```
      --feature-gates=RotateKubeletServerCertificate=true
    ```

    Based on your system, restart the `kubelet` service. For example:
    ```
       systemctl daemon-reload
       systemctl restart kubelet.service
    ```

    By default, kubelet server certificate rotation is disabled.

    Example:
    ```yaml
        apiVersion: v1
        kind: Pod
        metadata:
          annotations:
            scheduler.alpha.kubernetes.io/critical-pod: ""
          labels:
            component: kubelet
            tier: control-plane
          name: kubelet
          namespace: kube-system
        spec:
          containers:
          - command:
            - kubelet
            - --address="0.0.0.0"
            - --anonymous-auth=false
            - --rotate-certificates=true
    +       - --feature-gates=RotateKubeletServerCertificate=true
            ...
            ...
            image: gcr.io/google_containers/kubelet-amd64:v1.6.0
            name: kubelet
            volumeMounts:
            - mountPath: /etc/kubernetes/
              name: k8s
              readOnly: true
            - mountPath: /etc/ssl/certs
              name: certs
            - mountPath: /etc/pki
              name: pki
          hostNetwork: true
          volumes:
          - hostPath:
              path: /etc/kubernetes
            name: k8s
          - hostPath:
              path: /etc/ssl/certs
            name: certs
          - hostPath:
              path: /etc/pki
            name: pki
         ...
         ...
    ```

    #### References
    * https://kubernetes.io/docs/admin/kubelet/
    * https://github.com/kubernetes/kubernetes/pull/45059
    * https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/#kubelet-configuration

    #### CIS Controls
    **Version 6**
      *14.2 Encrypt All Sensitive Information Over Less-trusted Networks* -- All communication of sensitive information over less-trusted networks should be encrypted. Whenever information flows over a network with a lower trust level, the information should be encrypted.

    **Version 7**
      *14.4 Encrypt All Sensitive Information in Transit*
provider: Kubernetes
ruleId: CKV_K8S_150
severity: Medium
sid: ckv-k8s-150
title: "Ensure that the RotateKubeletServerCertificate argument is set to true"
