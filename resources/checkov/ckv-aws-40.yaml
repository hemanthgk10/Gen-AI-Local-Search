category: IAM
checkTool: checkov
checkType: CloudFormation
compliance:
- CIS
description: Ensure IAM policies are attached only to groups or roles (Reducing access
  management complexity may in-turn reduce opportunity for a principal to inadvertently
  receive or retain excessive privileges.) By default, IAM users, groups, and roles
  have no access to AWS resources. IAM policies are the means by which privileges
  are granted to users, groups, or roles. It is recommended that IAM policies be applied
  directly to groups and roles but not users.
extra:
  entity: AWS::IAM::Policy
  type: resource
guidelines: |-
  #### Description
  Ensure IAM policies are attached only to groups or roles (Reducing access management complexity may in-turn reduce opportunity for a principal to inadvertently receive or retain excessive privileges.) By default, IAM users, groups, and roles have no access to AWS resources. IAM policies are the means by which privileges are granted to users, groups, or roles. It is recommended that IAM policies be applied directly to groups and roles but not users.

  #### Rationale
  Assigning privileges at the group or role level reduces the complexity of access management as the number of users grow. Reducing access management complexity may in-turn reduce opportunity for a principal to inadvertently receive or retain excessive privileges.

  #### Remediation
  Remove argument `users` and use `groups` in `aws_iam_policy_attachment`. Prevent any policy that needs to have `users`. Assign all the policies to `groups` only.

  Terraform example:
  ```
  resource "aws_iam_policy_attachment" "test-attach" {
     name       = "test-attachment"
  -  users      = [aws_iam_user.user.name]
     roles      = [aws_iam_role.role.name]
  +  groups     = [aws_iam_group.group.name]
     policy_arn = aws_iam_policy.policy.arn
  }
  ```

  CloudFormation example:
  ```json
  {
     "Type" : "AWS::IAM::Policy",
     "Properties" : {
  +      "Groups" : [ "mygroup", "abc" ],
         "PolicyName" : "Group_plicy",
  -      "Users" : [ String, ... ],
         ...
         ...
     }
  }

  ```
  #### References
  * https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_user_policy_attachment
  * https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_user_policy
  * https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy_attachment#users
  * https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-policy.html
lwid:
  - AWS_CIS_1_16
provider: AWS
ruleId: CKV_AWS_40
severity: Low
sid: ckv-aws-40
title: "Ensure IAM policies are attached only to groups or roles"
