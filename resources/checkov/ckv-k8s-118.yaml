---
category: Security
checkTool: checkov
checkType: Kubernetes
compliance:
  - CIS
description: |-
    Kubernetes is an open source platform for orchestrating containers. A container is a technology that lets you bundle and isolate applications with their entire runtime environment so that it’s easy to move the contained application between stages (development, production, etc.) and environments (on-premise, public cloud, private cloud, hybrid cloud, or multicloud) while retaining full functionality.

    Kubernetes uses a popular key-value pair datastore (ETCD) for persisting the data in the cluster. ETCD is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.

    As ETCD might have sensitive information like tokens etc, so it should be configured to make use of TLS encryption for client connections.

    ETCD supports automatic TLS authentication through client certificates for both clients and server as well as peer (server to server / cluster) communication. This will create self-signed certificates which is not advisable for Production.
extra:
  entity: containers
  type: resource
guidelines: |-
    #### Description
    Kubernetes is an open source platform for orchestrating containers. A container is a technology that lets you bundle and isolate applications with their entire runtime environment so that it’s easy to move the contained application between stages (development, production, etc.) and environments (on-premise, public cloud, private cloud, hybrid cloud, or multicloud) while retaining full functionality.

    Kubernetes uses a popular key-value pair datastore (ETCD) for persisting the data in the cluster. ETCD is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.

    As ETCD might have sensitive information like tokens etc, so it should be configured to make use of TLS encryption for client connections.

    ETCD supports automatic TLS authentication through client certificates for both clients and server as well as peer (server to server / cluster) communication. This will create self-signed certificates which is not advisable for Production.

    #### Rationale
    ETCD is a highly-available key value store used by Kubernetes deployments for persistent storage of all of its REST API objects. These objects are sensitive in nature and should not be available to unauthenticated clients. You should enable the client authentication via valid certificates to secure the access to the etcd service.

    #### Audit
    Run the following command on the master node:
    ```
     ps -ef | grep etcd
    ```
    Verify that the `--auto-tls` argument exists, it is not set to `true`.

    #### Remediation
    Follow the etcd service documentation and configure TLS encryption. Then, edit the etcd pod specification file `/etc/kubernetes/manifests/etcd.yaml` on the master node and either remove the `--auto-tls` parameter or set it to `false`.
    ```
       --auto-tls=false
    ```

    By default, the etcd service can be queried by unauthenticated clients.

    Example:
    ```yaml
      apiVersion: v1
      kind: Pod
      metadata:
        annotations:
          scheduler.alpha.kubernetes.io/critical-pod: ""
        labels:
          component: etcd
          tier: control-plane
        name: etcd
        namespace: kube-system
      spec:
        containers:
        - command:
          - etcd
          - --advertise-client-urls=https://192.168.20.9:2379
          - --cert-file=/etc/kubernetes/pki/etcd/server.crt
          - --key-file=/etc/kubernetes/pki/etcd/server.key
    +     - --client-cert-auth=true
          - --data-dir=/var/lib/etcd
          - --initial-advertise-peer-urls=https://192.168.20.9:2380
          - --initial-cluster=test-master-01=https://192.168.20.9:2380
          - --listen-client-urls=https://192.168.20.9:2379
          - --listen-peer-urls=https://192.168.20.9:2380
          - --name=test-master-01
          - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt
          - --peer-client-cert-auth=true
          - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key
          - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
          - --snapshot-count=10000
          - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
          ...
          ...
          image: k8s.gcr.io/etcd-amd64:3.2.18
          imagePullPolicy: IfNotPresent
          name: etcd
          volumeMounts:
          - mountPath: /var/lib/etcd
            name: etcd-data
          - mountPath: /etc/kubernetes/pki/etcd
            name: etcd-certs
        hostNetwork: true
        priorityClassName: system-cluster-critical
        volumes:
        - hostPath:
            path: /var/lib/etcd
            type: DirectoryOrCreate
          name: etcd-data
        - hostPath:
            path: /etc/kubernetes/pki/etcd
            type: DirectoryOrCreate
          name: etcd-certs
        ...
        ...
    ```

    #### Impact
    Clients will not be able to use self-signed certificates for TLS.

    #### References
    * https://coreos.com/etcd/docs/latest/op-guide/security.html
    * https://kubernetes.io/docs/admin/etcd/
    * https://coreos.com/etcd/docs/latest/op-guide/configuration.html#auto-tls
    * https://etcd.io/docs/v3.2/op-guide/security/#:~:text=etcd%20supports%20automatic%20TLS%20as,key%20pair%20for%20one%20member

    #### CIS Controls:
    **Version 6**
      *14.2 Encrypt All Sensitive Information Over Less-trusted Networks* -- All communication of sensitive information over less-trusted networks should be encrypted. Whenever information flows over a network with a lower trust level, the information should be encrypted.

    **Version 7**
      *14.4 Encrypt All Sensitive Information in Transit* -- Encrypt all sensitive information in transit.
provider: Kubernetes
ruleId: CKV_K8S_118
severity: High
sid: ckv-k8s-118
title: "Ensure that the --auto-tls argument is not set to true"
