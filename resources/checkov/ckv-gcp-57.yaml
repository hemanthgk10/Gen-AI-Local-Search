category: Storage
checkTool: checkov
checkType: Terraform
compliance:
- CIS
description: Ensure PostgreSQL database 'log_min_duration_statement' flag is set to
  '-1'
extra:
  entity: google_sql_database_instance
  type: resource
guidelines: |-
  #### Description
  The `log_min_duration_statement` flag defines the minimum amount of execution time of a statement in milliseconds where the total duration of the statement is logged. Ensure that `log_min_duration_statement` is disabled, i.e., a value of `-1` is set.

  #### Rationale
  Logging SQL statements may include sensitive information that should not be recorded in logs. This recommendation is applicable to PostgreSQL database instances.

  #### Remediation
  By default `log_min_duration_statement` is `-1`.


  Terraform example
  ```
  resource "google_sql_database_instance" "master" {
      name             = "master-instance"
      database_version = "POSTGRES_11"
      region           = "us-central1"

      settings {
        tier = "db-f1-micro"
        database_flags {
  +         name  = "log_min_duration_statement"
  +         value = "-1"
        }
      }
      ...
      ...
  }
  ```


  Using *Console*
  1. Go to the [Cloud SQL Instances page](https://console.cloud.google.com/sql/instances)
  2. Select the PostgreSQL instance where the database flag needs to be enabled.
  3. Click `Edit`.
  4. Scroll down to the `Flags` section.
  5. To set a flag that has not been set on the instance before, click `Add` item, choose the flag `log_min_duration_statement` from the drop-down menu and set a value of `-1`.
  6. Click `Save`.
  7. Confirm the changes under `Flags` on the Overview page.


  Using *CLI*
  1. List all Cloud SQL database instances using the following command
  ```
  gcloud sql instances list
  ```
  2. Configure the `log_min_duration_statement` flag for every Cloud SQL PosgreSQL database instance using the below command.
  ```
  gcloud sql instances patch INSTANCE_NAME --database-flags log_min_duration_statement=-1

  Note: This command will overwrite all database flags previously set. To keep those and add new ones, include the values for all flags to be set on the instance; any flag not specifically included is set to its default value. For flags that do not take a value, specify the flag name followed by an equals sign ("=").
  ```

  #### References
  * https://cloud.google.com/sql/docs/postgres/flags
  * https://www.postgresql.org/docs/current/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT

  #### Notes
  ```
  WARNING: This patch modifies database flag values, which may require your instance to be restarted. Check the list of supported flags - https://cloud.google.com/sql/docs/postgres/flags - to see if your instance will be restarted when this patch is submitted.

  Note: Some database flag settings can affect instance availability or stability and remove the instance from the Cloud SQL SLA. For information about these flags, see Operational Guidelines.

  Note: Configuring the above flag does not require restarting the Cloud SQL instance.
  ```
lwid:
  - GCP_CIS12_6_2_16
provider: GCP
ruleId: CKV_GCP_57
severity: Low
sid: ckv-gcp-57
title: Googleg sql database log_min_duration_statement flag check
