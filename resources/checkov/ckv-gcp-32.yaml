category: Compute
checkTool: checkov
checkType: Terraform
compliance:
- CIS
description: Ensure 'Block Project-wide SSH keys' is enabled for VM instances
extra:
  entity: google_compute_instance
  type: resource
guidelines: |-
  #### Description
  It is recommended to user Instance specific SSH key(s) instead of using common/shared project-wide SSH key(s) to access Instances.

  #### Rationale
  Project-wide SSH keys are stored in `Compute/Project-meta-data`. Project wide SSH keys can be used to login into all the instances within project. Using project-wide SSH keys eases the SSH key management but if compromised, poses the security risk which can impact all the instances within project. It is recommended to use Instance specific SSH keys which can limit the attack surface if the SSH keys are compromised.

  #### Remediation
  By Default `Block Project-wide SSH keys` is not enabled.

  Terraform example
  ```
  resource "google_compute_instance" "default" {
      name         = "test"
      machine_type = "e2-medium"
      zone         = "us-central1-a"

  +   metadata {
  +     block-project-ssh-keys = true
  +   }
      ...
      ...
  }
  ```

  Using *Console*

  1. Go to the [VM instances page](https://console.cloud.google.com/compute/instances). It will list all the instances from project.
  2. Click on the name of the Impacted instance.
  3. Click `Edit` in the toolbar.
  4. Under SSH Keys, go to the `Block project-wide SSH keys` checkbox.
  5. To block users with project-wide SSH keys from connecting to this instance, select `Block project-wide SSH keys`.
  6. Click `Save` at the bottom of the page.
  7. Repeat steps for every impacted Instance.

  Using *CLI*

  Block project-wide public SSH keys, set the metadata value to `TRUE`.

  ```
  gcloud compute instances add-metadata [INSTANCE_NAME] --metadata blockproject-ssh-keys=TRUE
  ```
  where [INSTANCE_NAME] is the name of the instance that you want to block project-wide public SSH keys.

  #### Impact
  Users already having Project-wide ssh key pairs and using third party SSH clients will lose access to the impacted Instances. For Project users using gcloud or GCP Console based SSH option, no manual key creation and distribution is required and will be handled by GCE (Google compute Engine) itself. To access Instance using third party SSH clients Instance specific SSH key pairs needs to be created and distributed to the required users.

  #### References
  * https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys
  * https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance#metadata
lwid: []
provider: GCP
ruleId: CKV_GCP_32
severity: High
sid: ckv-gcp-32
title: Ensure 'Block Project-wide SSH keys' is enabled for VM instances
