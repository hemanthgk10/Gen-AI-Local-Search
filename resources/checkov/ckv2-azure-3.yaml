---
category: Security
checkTool: checkov
checkType: Terraform
compliance:
  - CIS
description: "Enable Vulnerability Assessment (VA) Periodic recurring scans for critical SQL servers and corresponding SQL databases."
extra:
  entity: azurerm_sql_server
  type: resource
guidelines: |-
    #### Description
    Enable Vulnerability Assessment (VA) Periodic recurring scans for critical SQL servers and corresponding SQL databases.

    #### Rationale
    VA setting `Periodic recurring scans` schedules periodic (weekly) vulnerability scanning for the SQL server and corresponding Databases. Periodic and regular vulnerability scanning provides risk visibility based on updated known vulnerability signatures and best practices.

    #### Impact
    Enabling the `Azure Defender for SQL` features will incur additional costs for each SQL server.

    #### Remediation
    Enabling Azure Defender for SQL enables `Periodic recurring scans` by default but does not configure the Storage account. Make sure that `recurring_scans` is enabled on `azurerm_mssql_server_vulnerability_assessment` and also make sure that `azurerm_mssql_server_security_alert_policy` is enabled.

    Terraform example
    ```
    resource "azurerm_mysql_server" "example" {
        name                         = "mysqlserver"
        version                      = "12.0"
        ...
        ...
    }

    resource "azurerm_storage_account" "example" {
        name                     = "storageaccountname"
        account_kind             = "StorageV2"
        account_tier             = "Standard"
        account_replication_type = "GRS"
        ...
        ...
    }

    resource "azurerm_mssql_server_security_alert_policy" "example" {
        server_name                = azurerm_mysql_server.example.name
    +   state                      = "Enabled"
        storage_endpoint           = azurerm_storage_account.example.primary_blob_endpoint
        storage_account_access_key = azurerm_storage_account.example.primary_access_key
        ...
        ...
    }

    resource "azurerm_mssql_server_vulnerability_assessment" "example" {
        server_security_alert_policy_id = azurerm_mssql_server_security_alert_policy.example.id
        storage_container_path          = "${azurerm_storage_account.example.primary_blob_endpoint}${azurerm_storage_container.example.name}/"
        storage_account_access_key      = azurerm_storage_account.example.primary_access_key

    +   recurring_scans {
    +     enabled = true
    +   }
        ...
        ...
    }
    ```

    #### References
    * https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment
    * https://docs.microsoft.com/en-us/rest/api/sql/servervulnerabilityassessments/listbyserver
    * https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Update-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0
    * https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Get-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0
    * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-posture-vulnerability-management#pv-6-perform-software-vulnerability-assessments
    * https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_server_vulnerability_assessment#recurring_scans
    * https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_server_security_alert_policy
    * https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_server
lwid:
  - Azure_CIS_131_4_2_3
provider: Azure
ruleId: CKV2_AZURE_3
severity: Low
sid: ckv2-azure-3
title: "Ensure that VA setting Periodic Recurring Scans is enabled on a SQL server"
