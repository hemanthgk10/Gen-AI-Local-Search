category: Storage
checkTool: checkov
checkType: CloudFormation
compliance:
- HIPAA
description: Ensure all data stored in the Elasticsearch is securely encrypted at
  rest. This prevents unauthorized access to the data stored in elastic search.
extra:
  entity: AWS::Elasticsearch::Domain
  type: resource
guidelines: |-
  #### Description
  Ensure that the `encrypt_at_rest` option in terraform for the `aws_elasticsearch_domain` is true. When enabled, this option uses Amazon's Key Management Service to transparently encrypt data written to disk by the the Amazon Elasticsearch service.

  #### Rationale
  If `encrypt_at_rest` is not enabled, Elasticsearch data is written to Amazon Elastic Block Store (EBS) volumes unencrypted. The unencrypted data could be readable by anyone who obtains access to the physical disk where your data is stored. Enabling encryption at rest to mitigate this issue is a common regulatory requirement.

  #### Remediation
  Set `encrypt_at_rest.enabled` to true and provide the `kms_key_id` for encryption.

  Terraform Example:
  ```
  data "aws_kms_alias" "es" {}

  resource "aws_elasticsearch_domain" "es" {
      domain_name           = "${var.es_domain_name}"
      elasticsearch_version = "${var.es_version}"

      # Encryption not enabled for all instance types
  +   encrypt_at_rest {
  +     enabled = true
  +     kms_key_id = data.aws_kms_alias.es.target_key_id
  +   }
      ...
      ...
  }
  ```

  CloudFormation Example:
  ```json
  {
      "Type" : "AWS::Elasticsearch::Domain",
      "Properties" : {
          "DomainName" : "sample-domain-example",
          "ElasticsearchVersion" : "2.3",
  +       "EncryptionAtRestOptions" : {
  +          "Enabled" : true,
  +          "KmsKeyId" : "<Provide the ARN for KMS Key"
  +       },
          ...
          ...
        }
  }
  ```

  #### References
  * https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/elasticsearch_domain#encrypt_at_rest
  * https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/encryption-at-rest.html
  * https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticsearch-domain.html#cfn-elasticsearch-domain-elasticsearchversion
  * https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/elasticsearch_domain
lwid:
  - LW_AWS_ELASTICSEARCH_3
provider: AWS
ruleId: CKV_AWS_5
severity: High
sid: ckv-aws-5
title: Ensure all data stored in the Elasticsearch is securely encrypted at rest
autofix: true
remediation:
- checkType: CloudFormation
  steps:
  - actions: add
    resource: [ "resource" ]
    resourceAttribute: EncryptionAtRestOptions
    resourceAttributeType: block
    resourceAttributeValue: |-
      {
          "KmsKeyId" = "<Provide the ARN for KMS key>",
          "Enabled" = true
      }
    resourceType: [ "AWS::Elasticsearch::Domain", "AWS::OpenSearchService::Domain" ]
- checkType: Terraform
  steps:
  - action: add
    resource: [ "resource" ]
    resourceAttribute: encrypt_at_rest
    resourceAttributeType: block
    resourceAttributeValue: |-
        encrypt_at_rest {
          kms_key_id = "<Provide the ARN for KMS key>"
          enabled = true
        }
    resourceType: [ "aws_elasticsearch_domain", "aws_opensearch_domain" ]
