category: General
checkTool: checkov
checkType: Terraform
compliance:
- CIS
description: Network Security Group (NSG) Flow Logs should be enabled and the retention
  period is set to greater than or equal to 90 days
extra:
  entity: Microsoft.Network/networkWatchers/FlowLogs/
  type: resource
guidelines: |-
  #### Description
  Network Security Group (NSG) Flow Logs should be enabled and the retention period is set to greater than or equal to 90 days.

  #### Rationale
  Flow logs enable capturing information about IP traffic flowing in and out of network security groups. Logs can be used to check for anomalies and give insight into suspected breaches.

  #### Remediation

  Azure Console
    1. Go to `Network Watcher`
    2. Select `NSG flow` logs blade in the Logs section
    3. Select each Network Security Group from the list
    4. Ensure  `Status` is set to `On`
    5. Ensure `Retention (days)` setting `greater than 90 days`
    6. Select your storage account in the `Storage account` field
    7. Select `Save`

  Azure Command Line Interface 2.0
  Enable the NSG flow logs and set the Retention (days) to greater than or equal to 90 days.

  ```
   az network watcher flow-log configure --nsg <NameorID of the Network Security Group> --enabled true --resource-group <resourceGroupName> --retention 91 -- storage-account <NameorID of the storage account to save flow logs>
  ```

  By default, Network Security Group Flow Logs are `disabled`.

  Terraform example, set the `rentention_policy` to `enabled` and retention `days` to 90 or greater.

  ```
  resource "azurerm_network_watcher_flow_log" "test" {
      network_watcher_name = azurerm_network_watcher.test.name
      resource_group_name  = azurerm_resource_group.test.name

      network_security_group_id = azurerm_network_security_group.test.id
      storage_account_id        = azurerm_storage_account.test.id
      enabled                   = true

  +   retention_policy {
  +     enabled = true
  +     days    = 90
  +   }
      ...
      ...
  }
  ```

  #### References
  * https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview
  * https://docs.microsoft.com/en-us/cli/azure/network/watcher/flow-log?view=azure-cli-latest
  * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-logging-threat-detection#lt-6-configure-log-storage-retention
lwid: []
provider: Azure
ruleId: CKV_AZURE_12
severity: Low
sid: ckv-azure-12
title: Network Security Group Flow Log retention period is more than 90 days
