category: Storage
checkTool: checkov
checkType: Terraform
compliance:
- CIS
description: Ensure SQL database 'cross db ownership chaining' flag is set to 'off'
extra:
  entity: google_sql_database_instance
  type: resource
guidelines: |-
  #### Description
  It is recommended to set `cross db ownership chaining database` flag for Cloud SQL SQL Server instance to `off`.

  #### Rationale
  Use the `cross db ownership` for chaining option to configure cross-database ownership chaining for an instance of Microsoft SQL Server. This server option allows you to control cross-database ownership chaining at the database level or to allow cross-database ownership chaining for all databases. Enabling `cross db ownership` is not recommended unless all of the databases hosted by the instance of SQL Server must participate in cross- database ownership chaining and you are aware of the security implications of this setting.This recommendation is applicable to SQL Server database instances.

  #### Remediation

  Terraform example
  ```
  resource "google_sql_database_instance" "master" {
      name             = "master-instance"
      database_version = "POSTGRES_11"
      region           = "us-central1"

      settings {
        tier = "db-f1-micro"
        database_flags {
  +         name  = "cross db ownership chaining"
  +         value = "off"
        }
      }
      ...
      ...
  }
  ```

  Using *Console*
  1. Go to the [Cloud SQL Instances page](https://console.cloud.google.com/sql/instances)
  2. Select the PostgreSQL instance where the database flag needs to be enabled.
  3. Click `Edit`.
  4. Scroll down to the `Flags` section.
  5. To set a flag that has not been set on the instance before, click `Add` item, choose the flag `cross db ownership chaining` from the drop-down menu and set a value to `off`.
  6. Click `Save`.
  7. Confirm the changes under `Flags` on the Overview page.

  Using *CLI*
  1. List all Cloud SQL database instances using the following command
  ```
  gcloud sql instances list
  ```
  2. Configure the `cross db ownership chaining` flag for every Cloud SQL PosgreSQL database instance using the below command.
  ```
   gcloud sql instances patch INSTANCE_NAME --database-flags "cross db ownership chaining=off"

  Note: This command will overwrite all database flags previously set. To keep those and add new ones, include the values for all flags to be set on the instance; any flag not specifically included is set to its default value. For flags that do not take a value, specify the flag name followed by an equals sign ("=").
  ```


  #### References
  * https://cloud.google.com/sql/docs/sqlserver/flags
  * https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/cross-db-ownership-chaining-server-configuration-option?view=sql-server-ver15

  #### Notes
  ```
  WARNING: This patch modifies database flag values, which may require your instance to be restarted. Check the list of supported flags -
  https://cloud.google.com/sql/docs/sqlserver/flags - to see if your instance will be restarted when this patch is submitted.

  Note: Some database flag settings can affect instance availability or stability, and remove the instance from the Cloud SQL SLA. For information about these flags, see Operational Guidelines.
  Note: Configuring the above flag does not restart the Cloud SQL instance.
  ```
lwid:
  - GCP_CIS12_6_3_2
provider: GCP
ruleId: CKV_GCP_58
severity: Low
sid: ckv-gcp-58
title: Google sql database cross db ownership chaining flag check
