---
category: "Backup & Recovery"
checkTool: checkov
checkType: Terraform
compliance: []
description: "Ensure that virtual machines are backed up using Azure Backup"
extra:
  entity: azurerm_virtual_machine
  type: resource
guidelines: |-
    #### Description
    Ensure that virtual machines are backed up using Azure Backup.

    #### Rationale
    Azure Backup provides independent and isolated backups to guard against accidental destruction of original data. Backups are stored in a Recovery Services vault with built-in management of recovery points.
    Configuration and scalability are simple, backups are optimized, and you can easily restore as needed.

    #### Impact
    Using Customer Managed Keys may also incur additional man-hour requirements to create, store, manage, and protect the keys as needed.

    #### Remediation
    Configure Azure Backup VM Backup Policy for all the Azure virtual machines using `azurerm_backup_policy_vm` and `azurerm_backup_protected_vm`.

    Terraform example
    ```
    resource "azurerm_virtual_machine" "example" {
        name                  = "acctvm"
        vm_size               = "Standard_F2"
        ...
        ...
    }

    + resource "azurerm_backup_policy_vm" "example" {
    +    name                = "tfex-recovery-vault-policy"
    +    backup {
    +      frequency = "Daily"
    +      time      = "23:00"
    +    }
    +    ...
    +    ...
    + }

    + resource "azurerm_backup_protected_vm" "vm1" {
    +    resource_group_name = azurerm_resource_group.example.name
    +    source_vm_id        = azurerm_virtual_machine.example.id
    +    backup_policy_id    = azurerm_backup_policy_vm.example.id
    +    ...
    +    ...
    + }
    ```

    #### Note
    The `azurerm_virtual_machine` resource has been superseded by the `azurerm_linux_virtual_machine` and `azurerm_windows_virtual_machine` resources.
    The existing `azurerm_virtual_machine` resource will continue to be available throughout the 2.x releases however is in a feature-frozen state to maintain compatibility - new functionality will instead be added to the `azurerm_linux_virtual_machine` and `azurerm_windows_virtual_machine` resources.

    #### References
    * https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/backup_protected_vm
    * https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/backup_policy_vm
    * https://docs.microsoft.com/en-us/azure/backup/backup-azure-vms-first-look-arm#:~:text=without%20user%20intervention.-,Back%20up%20from%20Azure%20VM%20settings,the%20VM%20menu%2C%20select%20Backup.
    * https://docs.microsoft.com/en-us/azure/backup/backup-azure-arm-vms-prepare
lwid: []
provider: Azure
ruleId: CKV2_AZURE_12
severity: Low
sid: ckv2-azure-12
title: "Ensure that virtual machines are backed up using Azure Backup"
