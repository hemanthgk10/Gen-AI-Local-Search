---
autofix: true
category: Logging
checkTool: tfsec
checkType: Terraform
compliance:
  - HIPAA
description: "API Gateway stages should have access log settings block configured to track all access to a particular stage. This should be applied to both v1 and v2 gateway stages."
extra:
  srcUrl: "https://github.com/tfsec/tfsec/blob/master/internal/app/tfsec/checks/aws061.go"
guidelines: |-
    #### Description
    AWS API gateway acts as an entry point for applications to access data, business logic or functionality of your
    application backend. It handles the all the API calls to your backend application including traffic management, CORS,
    authorization and access control, throttling, monitoring, and API version management. There are two types of logs for
    API gateway: execution logs and access logs.

    * Execution logs process creates log groups and log streams, and reports the log streams of any caller's requests and
    responses to cloudwatch logs.

    * Access logs provides information on who accessed your API and how it was accessed etc.

    #### Rationale
    Enabling the AWS API Gateway access logging provides information for auditing purpose in future to know who accessed the
    API and how did they access it etc.

    #### Remediation
    Set the `access_log_settings` section in `aws_api_gateway_stage` and aws_apigatewayv2_stage. Specify the destination cloudwatch arn and format of the log.

    Terraform example
    ```
    resource "aws_api_gateway_stage" "example" {
        api_id     = aws_api_gateway_rest_api.test.id
    +   access_log_settings  {
    +      destination_arn   = "arn:aws:iam::187416307283:log-group:API-Gateway-Execution-Logs/abd"
    +      format            = "$context.identity.sourceIp $context.identity.caller"
    +   }
        ...
        ...
    }

    resource "aws_apigatewayv2_stage" "example_v2" {
         api_id = aws_apigatewayv2_api.example.id
         name   = "example-v2-stage"

    +    access_log_settings {
    +      destination_arn = "arn:aws:iam::187416307283:log-group:API-Gateway-Execution-Logs/abd"
    +      format          = "$context.identity.sourceIp $context.identity.caller"
    +    }
         ...
         ...
    }
    ```

    #### References
    * https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/apigatewayv2_stage#access_log_settings
    * https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html
    * https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html#apigateway-cloudwatch-log-formats
lwid: []
provider: AWS
remediation:
  -
    checkType: Terraform
    steps:
      -
        action: add
        resource:
          - resource
        resourceAttribute: access_log_settings
        resourceAttributeType: block
        resourceAttributeValue: |-
            access_log_settings {
               destination_arn  = "<Provide the ARN for the API Gateway log group>"
               format           = "$context.identity.sourceIp $context.identity.caller"
            }
        resourceType:
          - aws_apigatewayv2_stage
          - aws_api_gateway_stage
ruleId: AWS061
severity: Low
sid: tfsec-aws061
title: "API Gateway stages for V1 and V2 should have access logging enabled"
