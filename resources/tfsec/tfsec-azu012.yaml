---
autofix: true
category: Network
checkTool: tfsec
checkType: Terraform
compliance: []
description: "The default_action for network rules should come into effect when no other rules are matched. The default action should be set to Deny."
extra:
  srcUrl: "https://github.com/tfsec/tfsec/blob/master/internal/app/tfsec/checks/azu012.go"
guidelines: |-
    #### Description
    Restricting default network access helps to provide a new layer of security, since storage accounts accept connections from clients on any network. To limit access to selected networks, the default action must be changed.

    #### Rationale
    Storage accounts should be configured to deny access to traffic from all networks (including internet traffic). Access can be granted to traffic from specific Azure Virtual networks, allowing a secure network boundary for specific applications to be built. Access can also be granted to public internet IP address ranges, to enable connections from specific internet or on-premises clients. When network rules are configured, only applications from allowed networks can access a storage account. When calling from an allowed network, applications continue to require proper authorization (a valid access key or SAS token) to access the storage account.

    #### Remediation
    Set the `default_action` in `azurerm_storage_account_network_rules` to `Deny`.

    Terraform example

    ```
      resource "azurerm_storage_account_network_rules" "test" {
          resource_group_name  = azurerm_resource_group.test.name
          storage_account_name = azurerm_storage_account.test.name
    -     default_action       = "Allow"
    +     default_action       = "Deny"
          ...
          ...
      }
    ```

    From *Azure Console*
      1. Go to `Storage Accounts`
      2. For each storage account, Click on the `settings` menu called `Firewalls` and `virtual networks`.
      3. Ensure that you have elected to allow access from `Selected networks`.
      4. Add rules to `allow traffic` from `specific network`.
      5. Click Save to apply your changes.

    From *Azure Command Line Interface 2.0*
    Use the below command to update *default-action* to *Deny*.

    ```
     az storage account update --name <StorageAccountName> --resource-group <resourceGroupName> --default-action Deny
    ```

    #### References
    * https://docs.microsoft.com/en-us/azure/storage/common/storage-network-security
    * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-governance-strategy#gs-6-define-identity-and-privileged-access-strategy
    * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-governance-strategy#gs-2-define-enterprise-segmentation-strategy
    * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-privileged-access#pa-8-choose-approval-process-for-microsoft-support
    * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-privileged-access#pa-5-automate-entitlement-management
    * https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-privileged-access#pa-4-set-up-emergency-access-in-azure-ad
    * https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account_network_rules#default_action
lwid: []
provider: Azure
remediation:
  -
    checkType: Terraform
    steps:
      -
        action: modify
        resource:
          - resource
        resourceAttribute: default_action
        resourceAttributeType: string
        resourceAttributeValue: Deny
        resourceType:
          - azurerm_storage_account_network_rules
ruleId: AZU012
severity: High
sid: tfsec-azu012
title: "The default action on Storage account network rules should be set to deny"
